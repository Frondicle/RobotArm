#generated with Grasshopper for Rhino
#Chris Morrey

import os
import sys
import time
import math

sys.path.append("C:\\Users\\morr0289\\Documents\\Github\\RobotArm\\Python")#Python\\final\\")

from arm_sdk3.xarm.wrapper.xarm_api import XArmAPI
arm = XArmAPI('192.168.1.240')
id = 9
baudRate = 9600

code, digitals = arm.get_tgpio_digital()

if arm.warn_code != 0:
    arm.clean_warn()
if arm.error_code != 0:
    arm.clean_error()
time.sleep(2)

ret = arm.core.set_modbus_timeout(7)  
print('set modbus timeout, ret = %d' % (ret[0]))    
ret = arm.core.set_modbus_baudrate(baudRate)  
print('set modbus baudrate, ret = %d' % (ret[0]))

time.sleep(1)
line = 104

def errors(returned):
    if returned == 1:
        print('1: uncleared error exists')
    elif returned == 23:
        print('23:modbus reply length error')
    elif returned == 20:
        print('20: wrong slave id')
    elif returned == 15:
        print('15: Modbus commands full')
    elif returned == 19:
        print('19: communication error')
    elif returned == 28:
        print('28: end module communication error')
    else:
        print('other error: ',returned)
    input=('clear errors? (y/n)')
    if input == 'y':
            arm.clean_error()
    else:
        print('error not cleared; quitting...')
        time.sleep(2)
        quit()

def sender(data_frame):
    global id
    arm.clean_error()
    time.sleep(.01)
    #while arm.connected and arm.error_code != 19 and arm.error_code != 28:
    if code == 0 and digitals[0] == 1:
        print ('extruder reports ready')
        ret = arm.getset_tgpio_modbus_data(data_frame,host_id=id)
        if ret[0] == 0:
            #print('wrote move: ',data_frame[8],data_frame[9],data_frame[10])
            print('wrote move: ',data_frame[9],data_frame[10])
            print('wrote speed: ',data_frame[11],data_frame[12])
            print('wrote line: ',data_frame[13],data_frame[14])
            print('wrote end: ',data_frame[15],data_frame[16])
            print('got back this: ',ret[1])
            #line += 3
    elif digitals [0] == 0:
        print('extruder reports not ready')
    elif code != 0:
        errors(ret[0])

arm.motion_enable(enable=True)
arm.set_mode(0)
arm.set_state(state=0)

arm.set_tcp_load(weight=0.91, center_of_gravity=[0,80,-40]) 
arm.set_tcp_offset([0,0,111.5,0,30.3,0], is_radian=False)
arm.set_collision_tool_model(22, x=40, y=40, z=111.5)

last_digitals = [-1, -1]

'''TGPIO for air solenoid---------------------------------------------
value = 0

    code = arm.set_cgpio_digital_output_function(i, value)
    print('set_cgpio_digital_output_function({}, {}), code={}'.format(i, value, code))
# Reset: 255
for i in range(4, 8):
    code = arm.set_cgpio_digital_output_function(i, 255)
    print('set_cgpio_digital_output_function({}, {}), code={}'.format(i, value, code))'''


arm.reset(wait=True)
if arm.warn_code != 0:
    arm.clean_warn()
if arm.error_code != 0:
    arm.clean_error()
time.sleep(2)

'''datas format: [0x09: slave id,0x10 function 16 write registers,0x00,0x00 beginning address to write,0x00,0x05 number of registers,0x0a number of bytes(2x registers),0x00,0x15 register 0 movement,0x00,0x06 register 1 speed,0x00,0x01 register 2 direction,0x00,0x64 register 3 line number,0x00,0x00 register 4 end of file]'''

while arm.connected:
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0x6a,0x00,0x15,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0x6d,0x00,0x05,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0x70,0x00,0x1f,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0x73,0x00,0x04,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0x76,0x00,0x26,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0x79,0x00,0x03,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0x7c,0x00,0x2c,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0x7f,0x00,0x03,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0x82,0x00,0x31,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0x85,0x00,0x03,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0x88,0x00,0x36,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0x8b,0x00,0x03,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0x8e,0x00,0x3a,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0x91,0x00,0x03,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0x94,0x00,0x3e,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0x97,0x00,0x03,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0x9a,0x00,0x42,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0x9d,0x00,0x03,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0xa0,0x00,0x45,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0xa3,0x00,0x02,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0xa6,0x00,0x48,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0xa9,0x00,0x02,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0xac,0x00,0x4b,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0xaf,0x00,0x02,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0xb2,0x00,0x4d,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0xb5,0x00,0x02,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0xb8,0x00,0x50,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0xbb,0x00,0x02,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0xbe,0x00,0x52,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0xc1,0x00,0x02,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0xc4,0x00,0x55,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0xc7,0x00,0x02,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0xca,0x00,0x57,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0xcd,0x00,0x02,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0xd0,0x00,0x59,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0xd3,0x00,0x02,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0xd6,0x00,0x5b,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0xd9,0x00,0x02,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0xdc,0x00,0x5c,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0xdf,0x00,0x02,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0xe2,0x00,0x5e,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0xe5,0x00,0x02,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0xe8,0x00,0x60,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0xeb,0x00,0x02,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0xee,0x00,0x61,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0xf1,0x00,0x02,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0xf4,0x00,0x63,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0xf7,0x00,0x02,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0xfa,0x00,0x64,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0xfd,0x00,0x02,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x00,0x00,0x66,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x03,0x00,0x02,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x06,0x00,0x67,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x09,0x00,0x02,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x0c,0x00,0x68,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x0f,0x00,0x02,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x12,0x00,0x69,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x15,0x00,0x02,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x18,0x00,0x6a,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x1b,0x00,0x02,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x1e,0x00,0x6b,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x21,0x00,0x02,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x24,0x00,0x6c,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x27,0x00,0x02,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x2a,0x00,0x6d,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x2d,0x00,0x02,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x30,0x00,0x6e,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x33,0x00,0x02,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x36,0x00,0x6f,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x39,0x00,0x02,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x3c,0x00,0x70,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x3f,0x00,0x02,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x42,0x00,0x70,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x45,0x00,0x02,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x48,0x00,0x71,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x4b,0x00,0x02,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x4e,0x00,0x72,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x51,0x00,0x02,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x54,0x00,0x72,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x57,0x00,0x02,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x5a,0x00,0x73,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x5d,0x00,0x02,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x60,0x00,0x73,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x63,0x00,0x02,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x66,0x00,0x73,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x69,0x00,0x02,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x6c,0x00,0x74,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x6f,0x00,0x02,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x72,0x00,0x74,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x75,0x00,0x02,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x78,0x00,0x74,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x7b,0x00,0x02,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x7e,0x00,0x75,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x81,0x00,0x02,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x84,0x00,0x75,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x87,0x00,0x02,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x8a,0x00,0x75,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
	datas = [0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x01,0x8d,0x00,0x02,0x00,0x06,0x00,0x01,0x00,0x00]
	sender(datas)
#finish up:   
datas =[0x09,0x10,0x00,0x00,0x00,0x05,0x0a,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01]
sender(datas)
time.sleep(2)
arm.reset(wait=True)
arm.disconnect()
